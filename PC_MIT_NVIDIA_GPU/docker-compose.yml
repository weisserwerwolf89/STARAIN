services:
  music-analyze:
    container_name: music-analyze
    user: "${PUID}:${PGID}"
    build:
      context: .
      dockerfile: Dockerfile.pc
    restart: unless-stopped

    # NVIDIA GPU Aktivierung (bleibt erhalten!)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - PYTHONUNBUFFERED=1
      - TZ=${TZ}
      - AUSSORTIERT_PATH=/aussortiert
    volumes:
      - "${HOST_MUSIC_DIR}:/music"
      - "${HOST_ANCHOR_DIR}:/anker"
      - "${HOST_SORT_DIR}:/aussortiert"
      - "${HOST_DATA_DIR}:/data"
    command: python3 analyze_loop.py --db /data/navidrome.db --music_dir /music
